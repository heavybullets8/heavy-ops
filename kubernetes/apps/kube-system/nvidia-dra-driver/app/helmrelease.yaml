---
# ⚠️ WARNING: Does not work on Talos yet
#
# https://github.com/NVIDIA/k8s-dra-driver-gpu/issues/605
#
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nvidia-dra-driver
spec:
  interval: 30m
  chart:
    spec:
      chart: nvidia-dra-driver-gpu
      version: 25.12.0
      sourceRef:
        kind: HelmRepository
        name: nvidia
      interval: 30m

  values:
    # Path to nvidia-cdi-hook on Talos nodes
    nvidiaCDIHookPath: /usr/local/bin/nvidia-cdi-hook

    # TODO: Enable when Talos support is added (not just when GPU subsystem is stable)
    # See warning at top of file for why this doesn't work on Talos
    resources:
      gpus:
        enabled: false
      computeDomains:
        enabled: false

    controller:
      priorityClassName: system-node-critical
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: Exists

    # Kubelet plugin configuration
    kubeletPlugin:
      priorityClassName: system-node-critical
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: extensions.talos.dev/nvidia-open-gpu-kernel-modules-production
                    operator: Exists
